    <script>
        const steps = [
            { id: 'customDate', title: 'Data', icon: 'üìÖ', label: 'Qual a data do registro?', type: 'date' },
            { id: 'uber', title: 'Ganhos Uber', icon: 'üöó', label: 'Valor total feito na Uber', type: 'number' },
            { id: 'pop', title: 'Ganhos 99', icon: 'üöï', label: 'Valor total na 99/Indriver', type: 'number' },
            { id: 'rentPaid', title: 'Aluguel (Hoje)', icon: 'üü£', label: 'Quanto separou hoje? (Sugest√£o abaixo)', type: 'number' },
            { id: 'fuel', title: 'Combust√≠vel', icon: '‚õΩ', label: 'Total gasto no posto', type: 'number' },
            { id: 'food', title: 'Alimenta√ß√£o', icon: 'üçî', label: 'Lanches e Refei√ß√µes', type: 'number' },
            { id: 'km', title: 'KM Rodados', icon: 'üõ£Ô∏è', label: 'Quilometragem do dia', type: 'number' },
            { id: 'hours', title: 'Horas Online', icon: '‚è±Ô∏è', label: 'Tempo Conectado (HH:MM)', type: 'time' },
            { id: 'rides', title: 'Viagens', icon: 'üî¢', label: 'Quantidade de corridas', type: 'number' }
        ];
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        let currentStep = 0, tempData = {}, viewDate = new Date(), editingIndex = null;
        const DB_KEY = 'app_motorista_v22'; 
        let tempOffDays = []; 
        let rentCalendarDate = new Date(); 
        let itemToDeleteIndex = null;
        window.isRegisterMode = false;

        // --- FUN√á√ÉO DE C√ÅLCULO DE ALUGUEL (V6 - L√≥gica de Cotas Pagas) ---
        // Agora o divisor diminui baseado em quantos pagamentos voc√™ registrou no banco
        function calculateTargetLogic(totalRent, offDaysArray, referenceDate = new Date()) {
            if (totalRent <= 0) return { target: 0, remaining: 0, daysLeft: 0 };

            const currentMonth = referenceDate.getMonth();
            const currentYear = referenceDate.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // 1. Total de dias que PODERIAM ter trabalho (M√™s inteiro - Folgas)
            let totalPotentialWorkDays = 0;
            for (let i = 1; i <= daysInMonth; i++) {
                if (!offDaysArray.includes(i)) {
                    totalPotentialWorkDays++;
                }
            }

            const db = getDB();
            let paidSoFar = 0;       
            let daysWithPayment = 0; // Quantas cotas j√° foram pagas

            // 2. Conta pagamentos no banco de dados (Passado ou Futuro)
            db.forEach(item => {
                let m = item.month, y = item.year;
                
                if (m === undefined || y === undefined) {
                    const p = item.date.split('/');
                    m = parseInt(p[1]) - 1; y = parseInt(p[2]);
                }

                if (m === currentMonth && y === currentYear) {
                    const val = (item.rentPaid || 0);
                    // Se pagou algo (> 0), conta como uma di√°ria abatida
                    if (val > 0) {
                        paidSoFar += val;
                        daysWithPayment++; 
                    }
                }
            });

            const remainingToPay = Math.max(0, totalRent - paidSoFar);
            
            // 3. Dias Restantes = (Dias Potenciais) - (Dias Pagos)
            let realRemainingDays = Math.max(0, totalPotentialWorkDays - daysWithPayment);

            // 4. C√°lculo final
            let target = 0;
            if (realRemainingDays > 0) {
                target = remainingToPay / realRemainingDays;
            } else {
                target = remainingToPay;
            }

            return { target: target, remaining: remainingToPay, daysLeft: realRemainingDays };
        }

        function toggleAuthMode() {
            window.isRegisterMode = !window.isRegisterMode;
            const btnMain = document.getElementById('btn-main-action');
            const txtToggle = document.getElementById('txt-toggle');
            const btnToggle = document.getElementById('btn-toggle');
            
            if(window.isRegisterMode) {
                btnMain.innerText = "CRIAR CONTA";
                txtToggle.innerText = "J√° tem conta?";
                btnToggle.innerText = "Fazer Login";
            } else {
                btnMain.innerText = "ENTRAR";
                txtToggle.innerText = "N√£o tem conta?";
                btnToggle.innerText = "Criar agora";
            }
        }

        function handleBackButton() {
            if(!document.getElementById('wizard-overlay').classList.contains('hidden')) { toggleWizard(false); return; }
            if(!document.getElementById('view-day-detail').classList.contains('hidden')) { closeDayDetail(); return; }
            if(!document.getElementById('modal-rent').classList.contains('hidden')) { closeRentConfig(); return; }
            if(!document.getElementById('view-history').classList.contains('hidden')) { switchTab('home'); return; }
        }
        function goBack() { window.history.back(); }

        function getDB() { try { return JSON.parse(localStorage.getItem(DB_KEY)) || []; } catch { return []; } }
        function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
        function migrateOldData() { const old = localStorage.getItem('app_motorista_v21'); if(old && !localStorage.getItem(DB_KEY)) localStorage.setItem(DB_KEY, old); }

        function openRentConfig() {
            window.history.pushState({modal: 'rent'}, "", "");
            document.getElementById('modal-rent').classList.remove('hidden');
            const config = JSON.parse(localStorage.getItem('rent_config')) || { total: 0, offDays: [] };
            document.getElementById('input-total-rent').value = config.total || '';
            tempOffDays = (config.offDays || []).map(Number);
            rentCalendarDate = new Date(); 
            renderRentCalendar();
            updateRentPreview();
        }

        function changeRentMonth(dir) {
            rentCalendarDate.setMonth(rentCalendarDate.getMonth() + dir);
            renderRentCalendar();
            updateRentPreview(); // Atualiza preview ao mudar m√™s
        }

        function renderRentCalendar() {
            const m = rentCalendarDate.getMonth();
            const y = rentCalendarDate.getFullYear();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const container = document.getElementById('rent-calendar');
            document.getElementById('cal-month-title').innerText = `${monthNames[m]} ${y}`;
            container.innerHTML = '';

            const db = getDB();
            const today = new Date();

            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'cal-day';
                dayDiv.innerText = i;
                
                // Verifica hist√≥rico visual
                const checkDateStr = `${i.toString().padStart(2, '0')}/${(m+1).toString().padStart(2, '0')}/${y}`;
                const hasRecord = db.some(item => item.date === checkDateStr);
                
                // L√≥gica visual simples: se tem registro √© verde escuro, se √© folga √© vermelho
                if (tempOffDays.includes(i)) {
                    dayDiv.classList.add('off');
                } else {
                    if (hasRecord) dayDiv.classList.add('past-working'); // Usando estilo de "j√° trabalhado" para registros
                    else dayDiv.classList.add('working');
                }
                
                if (i === today.getDate() && m === today.getMonth() && y === today.getFullYear()) dayDiv.classList.add('today');
                
                dayDiv.onclick = function() { toggleDayOff(i, dayDiv); };
                container.appendChild(dayDiv);
            }
        }

        function toggleDayOff(day, el) {
            if(tempOffDays.includes(day)) {
                tempOffDays = tempOffDays.filter(d => d !== day);
                el.classList.remove('off'); el.classList.add('working');
            } else {
                tempOffDays.push(day);
                el.classList.remove('working'); el.classList.add('off');
            }
            updateRentPreview();
        }

        function updateRentPreview() {
            const total = parseFloat(document.getElementById('input-total-rent').value) || 0;
            // ATUALIZADO: Passa a data do calend√°rio do modal
            const result = calculateTargetLogic(total, tempOffDays, rentCalendarDate);
            
            document.getElementById('rent-preview-val').innerText = formatMoney(result.target);
            document.getElementById('rent-debug-remaining').innerText = formatMoney(result.remaining);
            document.getElementById('rent-debug-days').innerText = result.daysLeft;
        }

        function saveRentConfig() {
            const valStr = document.getElementById('input-total-rent').value;
            const total = parseFloat(valStr) || 0;
            localStorage.setItem('rent_config', JSON.stringify({ total: total, offDays: tempOffDays }));
            alert("Planejamento Salvo!");
            closeRentConfig();
            
            const dashTarget = document.getElementById('dash-rent-target');
            if(dashTarget) {
                dashTarget.innerText = formatMoney(total);
                dashTarget.style.fontSize = "18px";
            }
            renderDashboard();
        }
        function closeRentConfig() { document.getElementById('modal-rent').classList.add('hidden'); }

        // --- DASHBOARD ---
        function renderDashboard() {
            window.renderDashboard = renderDashboard;
            const db = getDB();
            const m = viewDate.getMonth();
            const y = viewDate.getFullYear();
            
            document.getElementById('label-month').innerText = monthNames[m].toUpperCase();
            document.getElementById('label-year').innerText = y;

            const data = db.filter(item => {
                if (item.month !== undefined) return item.month === m && item.year === y;
                const parts = item.date.split('/');
                return parseInt(parts[1])-1 === m && parseInt(parts[2]) === y;
            });

            let tRev=0, tExp=0, tFuel=0, tFood=0, tRent=0, tHours=0, tKm=0;

            data.forEach(item => {
                tFuel += Number(item.fuel || 0);
                tFood += Number(item.food || 0);
                tRent += Number(item.rentPaid || 0);
                tRev += Number(item.uber || 0) + Number(item.pop || 0);
                tKm += Number(item.km || 0);

                let h = Number(item.hours);
                if (isNaN(h) || h === 0) {
                    if (item.hoursFormatted) {
                        const [hh, mm] = item.hoursFormatted.split(':').map(Number);
                        h = hh + (mm / 60);
                    } else {
                        h = 0;
                    }
                }
                tHours += h;
            });
            
            tExp = tFuel + tFood + tRent;
            const profit = tRev - tExp;

            document.getElementById('dash-profit').innerText = formatMoney(profit);
            document.getElementById('dash-rev').innerText = formatMoney(tRev);
            document.getElementById('dash-exp').innerText = formatMoney(tExp);
            document.getElementById('dash-fuel-val').innerText = formatMoney(tFuel);
            document.getElementById('dash-food-val').innerText = formatMoney(tFood);
            document.getElementById('dash-rent-val').innerText = formatMoney(tRent);
            document.getElementById('dash-fuel-pct').innerText = (tRev > 0 ? ((tFuel/tRev)*100).toFixed(1) : '0') + "%";
            document.getElementById('dash-hours').innerText = tHours.toFixed(1) + "h";
            
            const hourlyVal = tHours > 0 ? (profit / tHours) : 0; 
            document.getElementById('dash-hourly').innerText = formatMoney(hourlyVal);

            const kmVal = tKm > 0 ? (tRev / tKm) : 0;
            document.getElementById('dash-km-val').innerText = formatMoney(kmVal);

            const config = JSON.parse(localStorage.getItem('rent_config'));
            const totalRent = config ? Number(config.total) : 0;
            const dashTargetEl = document.getElementById('dash-rent-target');
            if(totalRent > 0) {
                dashTargetEl.innerText = formatMoney(totalRent);
                dashTargetEl.style.fontSize = "18px";
            } else {
                dashTargetEl.innerText = "Definir Meta";
                dashTargetEl.style.fontSize = "14px";
            }
        }

        // --- HIST√ìRICO ---
        function renderHistory() {
            window.renderHistory = renderHistory;
            const db = getDB(); const list = document.getElementById('history-list'); list.innerHTML = '';
            const groups = {};
            db.forEach((item, index) => {
                let m = item.month, y = item.year;
                if(m===undefined) { const p = item.date.split('/'); m=parseInt(p[1])-1; y=parseInt(p[2]); }
                const key = `${m}-${y}`;
                if(!groups[key]) groups[key] = { label: `${monthNames[m]} ${y}`, items: [] };
                item.originalIndex = index; groups[key].items.push(item);
            });
            Object.keys(groups).forEach(key => {
                const g = groups[key];
                const folder = document.createElement('div'); folder.className = 'month-folder';
                folder.innerHTML = `<span class="folder-title">üìÇ ${g.label}</span><span class="folder-icon">‚ñº</span>`;
                const itemsDiv = document.createElement('div'); itemsDiv.className = 'days-list';
                g.items.forEach(d => {
                    const rec = (d.uber||0)+(d.pop||0), luc = rec - ((d.fuel||0)+(d.food||0)+(d.rentPaid||0));
                    
                    let h = Number(d.hours || 0);
                    let hoursVal = h > 0 ? luc/h : 0;
                    let fuelPct = rec > 0 ? ((d.fuel||0)/rec)*100 : 0;
                    let tagsHtml = `<span class="tag tag-fuel">‚õΩ ${fuelPct.toFixed(0)}%</span>`;
                    if(h > 0) tagsHtml += `<span class="tag tag-hour" style="margin-left:5px;">‚è±Ô∏è ${d.hoursFormatted||h.toFixed(1)+'h'} ‚Ä¢ ${formatMoney(hoursVal)}/h</span>`;

                    const div = document.createElement('div'); div.className = 'history-item';
                    
                    div.innerHTML = `
                        <div onclick="openDayDetail(${d.originalIndex})" style="flex:1;">
                            <div class="date-badge">${d.date}</div>
                            <div class="sub-info">Lucro: ${formatMoney(luc)} <br> ${tagsHtml}</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <button onclick="askDelete(${d.originalIndex})" class="btn-trash">üóëÔ∏è</button>
                            <span onclick="openDayDetail(${d.originalIndex})" style="font-size:18px; color:#666; margin-left:10px;">‚ñ∂</span>
                        </div>`;
                    itemsDiv.appendChild(div);
                });
                folder.onclick = () => folder.classList.toggle('folder-open');
                list.appendChild(folder); list.appendChild(itemsDiv);
            });
        }

        function openDayDetail(index) {
            window.history.pushState({modal: 'detail'}, "", ""); currentDetailIndex = index;
            const d = getDB()[index]; if(!d) return;
            const rec = (d.uber||0)+(d.pop||0), desp = (d.fuel||0)+(d.food||0)+(d.rentPaid||0), luc = rec-desp;
            
            let h = Number(d.hours || 0);
            
            document.getElementById('detail-title').innerText = `Detalhes: ${d.date}`;
            document.getElementById('day-profit').innerText = formatMoney(luc);
            document.getElementById('day-rev').innerText = formatMoney(rec);
            document.getElementById('day-exp').innerText = formatMoney(desp);
            document.getElementById('day-fuel-val').innerText = formatMoney(d.fuel||0);
            document.getElementById('day-food-val').innerText = formatMoney(d.food||0);
            document.getElementById('day-rent-val').innerText = formatMoney(d.rentPaid||0);
            document.getElementById('day-uber').innerText = formatMoney(d.uber||0);
            document.getElementById('day-pop').innerText = formatMoney(d.pop||0);
            document.getElementById('day-fuel-pct').innerText = (rec>0?((d.fuel||0)/rec)*100:0).toFixed(1)+'%';
            document.getElementById('day-hours').innerText = (d.hoursFormatted||h.toFixed(1))+"h";
            document.getElementById('day-hourly').innerText = formatMoney(h>0?luc/h:0);
            document.getElementById('day-km-val').innerText = formatMoney(d.km>0?rec/d.km:0);
            
            // ATUALIZADO: Cria uma data baseada no registro para calcular o contexto correto
            const parts = d.date.split('/');
            const recordDate = new Date(parts[2], parts[1]-1, parts[0]);

            const config = JSON.parse(localStorage.getItem('rent_config'));
            // Passa a recordDate para a fun√ß√£o V6
            const res = config ? calculateTargetLogic(config.total, config.offDays||[], recordDate) : { target: 0, remaining: 0, daysLeft: 0 };
            
            document.getElementById('day-rent-target-val').innerText = formatMoney(res.target);
            document.getElementById('day-rent-math-expl').innerText = `Faltam ${formatMoney(res.remaining)} para os ${res.daysLeft} dias restantes`;

            document.getElementById('view-day-detail').classList.remove('hidden');
        }
        function closeDayDetail() { document.getElementById('view-day-detail').classList.add('hidden'); }

        function askDelete(index) { itemToDeleteIndex = index; document.getElementById('modal-delete').classList.remove('hidden'); }
        function closeDeleteModal() { itemToDeleteIndex = null; document.getElementById('modal-delete').classList.add('hidden'); }
        
        function confirmDelete() {
            if(itemToDeleteIndex !== null) {
                const db = getDB(); db.splice(itemToDeleteIndex, 1); saveDB(db);
                if(window.syncToCloud) window.syncToCloud();
                closeDeleteModal(); renderHistory(); renderDashboard(); closeDayDetail();
            }
        }
        
        function startWizard(indexToEdit = null) {
            window.history.pushState({modal: 'wizard'}, "", "");
            const config = JSON.parse(localStorage.getItem('rent_config'));
            
            // Define data de refer√™ncia (hoje ou data do registro editado)
            let refDate = new Date();
            if(indexToEdit !== null) {
                const temp = getDB()[indexToEdit];
                const p = temp.date.split('/');
                refDate = new Date(p[2], p[1]-1, p[0]);
            }
            
            const res = config ? calculateTargetLogic(config.total, config.offDays || [], refDate) : {target:0};

            if(indexToEdit !== null) { 
                editingIndex = indexToEdit; 
                tempData = {...getDB()[indexToEdit]}; 
                const p = tempData.date.split('/'); 
                tempData.customDate = `${p[2]}-${p[1]}-${p[0]}`; 
            }
            else { 
                editingIndex = null; 
                tempData = {}; 
                tempData.customDate = new Date().toISOString().split('T')[0]; 
                tempData.rentPaid = res.target; 
            }
            currentStep = 0; toggleWizard(true); renderStep();
        }
        function renderStep() {
            const s = steps[currentStep]; document.getElementById('step-counter').innerText = `ETAPA ${currentStep+1}/${steps.length}`;
            document.getElementById('progress-bar').style.width = `${((currentStep+1)/steps.length)*100}%`;
            document.getElementById('btn-next').innerText = (currentStep === steps.length - 1) ? 'SALVAR' : 'PR√ìXIMO';
            let val = tempData[s.id], html = s.type === 'date' ? `<input type="date" id="inp-val" class="step-input" value="${tempData.customDate}">` : s.type === 'time' ? `<input type="time" id="inp-val" class="step-input" style="color-scheme:dark;" value="${tempData.hoursFormatted||''}">` : `<input type="number" id="inp-val" class="step-input" placeholder="0" autofocus value="${val!==undefined && val!==0?val:''}">`;
            document.getElementById('wizard-content').innerHTML = `<div class="step-icon-circle">${s.icon}</div><h2>${s.title}</h2><p style="color:#888;">${s.label}</p>${html}`;
            if(s.id==='rentPaid' && val) {
                document.getElementById('inp-val').value = parseFloat(val).toFixed(2);
            }
            if(s.type!=='date'&&s.type!=='time') setTimeout(()=>document.getElementById('inp-val').focus(),100);
        }
        function nextStep(skip) {
            const el = document.getElementById('inp-val'), s = steps[currentStep];
            if(s.type === 'date') tempData.customDate = el.value;
            else if(s.type === 'time') { 
                if(skip||!el.value) tempData[s.id]=0; 
                else { 
                    tempData.hoursFormatted=el.value; 
                    const [h,m]=el.value.split(':').map(Number); 
                    tempData[s.id]=h+(m/60); 
                } 
            }
            else tempData[s.id] = skip ? 0 : (parseFloat(el.value)||0);
            
            if(currentStep < steps.length - 1) { currentStep++; renderStep(); } else saveEntry();
        }
        function saveEntry() {
            const db = getDB(), d = new Date(tempData.customDate+'T12:00:00');
            tempData.date = d.toLocaleDateString('pt-BR'); tempData.month = d.getMonth(); tempData.year = d.getFullYear();
            if(editingIndex!==null) db[editingIndex]=tempData; else { tempData.timestamp=Date.now(); if(tempData.rentPaid===undefined)tempData.rentPaid=0; db.unshift(tempData); }
            saveDB(db); 
            if(window.syncToCloud) window.syncToCloud();
            toggleWizard(false); renderDashboard(); renderHistory(); openDayDetail(editingIndex!==null?editingIndex:0);
        }
        function editCurrentDay() { closeDayDetail(); startWizard(currentDetailIndex); }
        function toggleWizard(show) { const el = document.getElementById('wizard-overlay'); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function prevStep() { if(currentStep > 0) { currentStep--; renderStep(); } }
        function switchTab(tab) {
            document.querySelectorAll('#view-dashboard, #view-history').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(tab === 'home') { document.getElementById('view-dashboard').classList.remove('hidden'); document.getElementById('nav-home').classList.add('active'); renderDashboard(); }
            else { window.history.pushState({page: 'history'}, "", ""); document.getElementById('view-history').classList.remove('hidden'); document.getElementById('nav-hist').classList.add('active'); renderHistory(); }
        }
        function changeMonth(dir) { viewDate.setMonth(viewDate.getMonth() + dir); renderDashboard(); }
        function formatMoney(n) { return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    </script>
